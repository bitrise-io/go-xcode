package xcodebuild

import (
	"reflect"
	"strings"
	"testing"
)

func TestCommandBuilder_cmdSlice(t *testing.T) {
	tests := []struct {
		name                              string
		projectPath                       string
		isWorkspace                       bool
		scheme                            string
		configuration                     string
		destination                       string
		forceDevelopmentTeam              string
		forceProvisioningProfileSpecifier string
		forceProvisioningProfile          string
		forceCodeSignIdentity             string
		disableCodesign                   bool
		disableIndexWhileBuilding         bool
		customBuildActions                []string
		archivePath                       string
		customOptions                     []string
		sdk                               string
		action                            Action
		want                              []string
	}{
		{
			name:                              "build simulator",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "id=3222ioocsdcsa1",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"id=3222ioocsdcsa1",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "build iphone simulator sdk",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "id=3222ioocsdcsa1",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "iphonesimulator12",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"id=3222ioocsdcsa1",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"-sdk",
				"iphonesimulator12",
				"",
			},
		},
		{
			name:                              "analyze simulator",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "id=3222ioocsdcsa1",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            AnalyzeAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"id=3222ioocsdcsa1",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"analyze",
				"",
			},
		},
		{
			name:                              "build simulator force development team",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "id=3222ioocsdcsa1",
			forceDevelopmentTeam:              "Bitrise",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   false,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"DEVELOPMENT_TEAM=Bitrise",
				"-destination",
				"id=3222ioocsdcsa1",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "build simulator force code sign identity",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "id=3222ioocsdcsa1",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "iOS Developer: Bitrise bot",
			disableCodesign:                   false,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=iOS Developer: Bitrise bot",
				"-destination",
				"id=3222ioocsdcsa1",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "build simulator force development team & profile",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "id=3222ioocsdcsa1",
			forceDevelopmentTeam:              "Bitrise",
			forceProvisioningProfileSpecifier: "id 2331232",
			forceProvisioningProfile:          "id 2331232",
			forceCodeSignIdentity:             "",
			disableCodesign:                   false,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"DEVELOPMENT_TEAM=Bitrise",
				"PROVISIONING_PROFILE_SPECIFIER=id 2331232",
				"PROVISIONING_PROFILE=id 2331232",
				"-destination",
				"id=3222ioocsdcsa1",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "build generic iOS",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "generic/platform=iOS",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"generic/platform=iOS",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "build generic iOS workspace",
			projectPath:                       "project.xcworkspace",
			isWorkspace:                       true,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "generic/platform=iOS",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-workspace",
				"project.xcworkspace",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"generic/platform=iOS",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "build generic iOS workspace debug configuration",
			projectPath:                       "project.xcworkspace",
			isWorkspace:                       true,
			scheme:                            "project",
			configuration:                     "debug",
			destination:                       "generic/platform=iOS",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-workspace",
				"project.xcworkspace",
				"-scheme",
				"project",
				"-configuration",
				"debug",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"generic/platform=iOS",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"build",
				"",
			},
		},
		{
			name:                              "archive generic iOS",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "generic/platform=iOS",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         true,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            ArchiveAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"generic/platform=iOS",
				"COMPILER_INDEX_STORE_ENABLE=NO",
				"",
				"archive",
				"-archivePath",
				"archive/path",
				"",
			},
		},
		{
			name:                              "build generic iOS index while building",
			projectPath:                       "project.xcodeproj",
			isWorkspace:                       false,
			scheme:                            "project",
			configuration:                     "",
			destination:                       "generic/platform=iOS",
			forceDevelopmentTeam:              "",
			forceProvisioningProfileSpecifier: "",
			forceProvisioningProfile:          "",
			forceCodeSignIdentity:             "",
			disableCodesign:                   true,
			disableIndexWhileBuilding:         false,
			customBuildActions:                []string{""},
			archivePath:                       "archive/path",
			customOptions:                     []string{""},
			sdk:                               "",
			action:                            BuildAction,
			want: []string{
				"xcodebuild",
				"-project",
				"project.xcodeproj",
				"-scheme",
				"project",
				"CODE_SIGN_IDENTITY=",
				"CODE_SIGNING_REQUIRED=NO",
				"PROVISIONING_PROFILE_SPECIFIER=",
				"PROVISIONING_PROFILE=",
				"DEVELOPMENT_TEAM=",
				"-destination",
				"generic/platform=iOS",
				"",
				"build",
				"",
			},
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			c := &CommandBuilder{
				projectPath:                       tt.projectPath,
				isWorkspace:                       tt.isWorkspace,
				scheme:                            tt.scheme,
				configuration:                     tt.configuration,
				destination:                       tt.destination,
				forceDevelopmentTeam:              tt.forceDevelopmentTeam,
				forceProvisioningProfileSpecifier: tt.forceProvisioningProfileSpecifier,
				forceProvisioningProfile:          tt.forceProvisioningProfile,
				forceCodeSignIdentity:             tt.forceCodeSignIdentity,
				disableCodesign:                   tt.disableCodesign,
				disableIndexWhileBuilding:         tt.disableIndexWhileBuilding,
				customBuildActions:                tt.customBuildActions,
				archivePath:                       tt.archivePath,
				customOptions:                     tt.customOptions,
				sdk:                               tt.sdk,
				action:                            tt.action,
			}
			if got := c.cmdSlice(); !reflect.DeepEqual(got, tt.want) {
				t.Errorf("CommandBuilder.cmdSlice() = %v\nwant %v", strings.Join(got, "\n"), strings.Join(tt.want, "\n"))
			}
		})
	}
}
