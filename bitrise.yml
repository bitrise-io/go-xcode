format_version: 1.0.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - ORIG_BITRISE_SOURCE_DIR: $BITRISE_SOURCE_DIR

workflows:
  ci:
    before_run:
    - test
    
  test:
    after_run:
    - integration-test
    - swiftpm_cache
    steps:
    - go-list:
    - golint:
    - errcheck:
    - go-test:

  integration-test:
    after_run:
    steps:
    - script:
        title: Run integration tests
        inputs:
        - content: |-
            #!/bin/bash
            echo "Running integration tests ..."
            set -ex

            go test -v ./_tests/integration/...

  _swiftpm_step:
    envs:
    - CURRENT_PROJECT_PATH: $CURRENT_PROJECT_PATH
    steps:
      - script:
          title: Cleanup $TMP_DIR
          inputs:
          - content: |
              #!/bin/bash
              set -ex
              rm -rf "$TMP_DIR"
              mkdir $TMP_DIR

              rm -rf /Users/lpusok/Library/Developer/Xcode/DerivedData/*
      - cache-pull:
          run_if: true
          inputs:
          - is_debug_mode: true 
          - cache_api_url: $CACHE_API_PATH
      - script:
          inputs:
          - content: |
              #!/bin/bash
              cp -r $CURRENT_PROJECT_PATH $TMP_DIR
      - xcode-test:
          title: Run xcodebuild
          inputs:
          - project_path: $TMP_DIR/sample-swiftpm2.xcodeproj
          - scheme: sample-swiftpm2
          - cache_level: swift_packages
      - cache-push:
          title: Push cache
          run_if: true
          is_skippable: false
          inputs:
          - cache_api_url: $CACHE_API_PATH
          - is_debug_mode: true

  _swiftpm_step2:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm2/
    after_run:
    - _swiftpm_step

  _swiftpm_step3:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm3/
    after_run:
    - _swiftpm_step

  _swiftpm_step4:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm4/
    after_run:
    - _swiftpm_step

  _swiftpm_step5:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm5/
    after_run:
    - _swiftpm_step
  
  _swiftpm_step6:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm6/
    after_run:
    - _swiftpm_step

  _swiftpm_step7:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm7/
    after_run:
    - _swiftpm_step

  _swiftpm_step8:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm8/
    after_run:
    - _swiftpm_step

  _swiftpm_step9:
    envs:
    - CURRENT_PROJECT_PATH: $SAMPLES_DIR/sample-swiftpm9/
    after_run:
    - _swiftpm_step

  swiftpm_cache:
    envs:
    - SAMPLES_DIR: $ORIG_BITRISE_SOURCE_DIR/_checkout
    - TMP_DIR: $ORIG_BITRISE_SOURCE_DIR/_tmp
    - CACHE_DIR: $ORIG_BITRISE_SOURCE_DIR/_cache
    - CACHE_API_PATH: "file://$CACHE_DIR/archive.tar.gz"
    steps:
    - script:
        title: Cleanup $CACHE_DIR, checkout samples
        inputs:
        - content: |
            #!/bin/bash
            set -ex
            rm -rf "$CACHE_DIR"
            mkdir $CACHE_DIR

            rm -rf $SAMPLES_DIR
            mkdir $SAMPLES_DIR
            git clone https://github.com/bitrise-io/sample-apps-ios-swiftpm.git -b master $SAMPLES_DIR
    after_run:
    - _swiftpm_step2
    - _swiftpm_step3
    - _swiftpm_step4
    - _swiftpm_step5
    - _swiftpm_step6
    - _swiftpm_step7
    - _swiftpm_step8
    - _swiftpm_step9
